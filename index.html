<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portable Web OS + Ruffle</title>
    <!-- Load Ruffle Emulator Engine -->
    <script src="https://unpkg.com"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body, html { margin: 0; padding: 0; overflow: hidden; background: #0f172a; }
        #desktop { width: 100vw; height: 100vh; position: relative; background-size: cover; }
        
        /* Icons */
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, 100px); gap: 15px; padding: 20px; }
        .icon { text-align: center; color: white; cursor: pointer; padding: 10px; border-radius: 8px; text-shadow: 1px 1px 3px black; }
        .icon:hover { background: rgba(255,255,255,0.2); }
        .icon-img { font-size: 45px; display: block; }

        /* Windows */
        .window { 
            position: absolute; background: #fff; border: 1px solid #333; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); display: none; 
            flex-direction: column; border-radius: 10px; overflow: hidden; z-index: 10;
        }
        .window-header { 
            background: #1e293b; color: white; padding: 10px; cursor: move; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { background: #ff5f56; border: none; color: white; border-radius: 50%; cursor: pointer; width: 20px; height: 20px; }
        .content { flex-grow: 1; overflow: auto; padding: 10px; }

        /* Taskbar */
        #taskbar { position: absolute; bottom: 0; width: 100%; height: 50px; background: rgba(0,0,0,0.8); display: flex; align-items: center; padding: 0 20px; gap: 10px; }
        .bar-btn { background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .save-btn { background: #10b981; }

        /* Flash Player Container */
        #ruffle-container { width: 100%; height: 100%; background: #000; }
    </style>
</head>
<body>

<div id="desktop">
    <div class="icon-grid">
        <div class="icon" onclick="openApp('ruffle-win')"><span class="icon-img">üïπÔ∏è</span>Flash Game</div>
        <div class="icon" onclick="openApp('cam'); startCamera()"><span class="icon-img">üì∑</span>Camera</div>
        <div class="icon" onclick="openApp('photos'); loadPhotos()"><span class="icon-img">üñºÔ∏è</span>Photos</div>
        <div class="icon" onclick="document.getElementById('file-input').click()"><span class="icon-img">üìÇ</span>Upload SWF</div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="file-input" style="display:none" accept=".swf" onchange="loadExternalFlash(this)">

    <!-- Ruffle Flash Player Window -->
    <div id="ruffle-win" class="window" style="width: 600px; height: 450px; top: 50px; left: 300px;">
        <div class="window-header"><span>Ruffle Player</span><button class="close-btn" onclick="closeApp('ruffle-win')">x</button></div>
        <div class="content" id="ruffle-content">
            <div id="ruffle-container"></div>
            <p style="font-size: 12px; color: #666;">Drag an .swf file onto the desktop icon to play.</p>
        </div>
    </div>

    <!-- Camera Window -->
    <div id="cam" class="window" style="width: 400px; top: 100px; left: 50px;">
        <div class="window-header"><span>Camera</span><button class="close-btn" onclick="closeApp('cam')">x</button></div>
        <div class="content">
            <video id="webcam" autoplay playsinline style="width:100%"></video>
            <button onclick="takePhoto()" style="width:100%; margin-top:10px; padding:10px; background:#10b981; color:white; border:none; cursor:pointer;">Capture</button>
            <canvas id="cam-canvas" style="display:none;"></canvas>
        </div>
    </div>

    <!-- Photos Window -->
    <div id="photos" class="window" style="width: 450px; height: 350px; top: 150px; left: 150px;">
        <div class="window-header"><span>Photo Gallery</span><button class="close-btn" onclick="closeApp('photos')">x</button></div>
        <div id="photo-list" class="content" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 5px;"></div>
    </div>

    <!-- Taskbar -->
    <div id="taskbar">
        <button class="bar-btn">Menu</button>
        <button class="bar-btn save-btn" onclick="exportOS()">üíæ Save OS State (.html)</button>
    </div>
</div>

<script>
    /* 1. App Management */
    function openApp(id) { document.getElementById(id).style.display = 'flex'; }
    function closeApp(id) { document.getElementById(id).style.display = 'none'; }

    /* 2. Ruffle Flash Logic */
    const ruffle = window.RufflePlayer.newest();
    const player = ruffle.createPlayer();
    document.getElementById("ruffle-container").appendChild(player);

    function loadExternalFlash(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                player.load({ data: e.target.result });
                openApp('ruffle-win');
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
    }

    /* 3. Camera & Photos */
    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('webcam').srcObject = stream;
    }

    function takePhoto() {
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cam-canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const imgData = canvas.toDataURL('image/png');
        let photos = JSON.parse(localStorage.getItem('os_photos') || "[]");
        photos.push(imgData);
        localStorage.setItem('os_photos', JSON.stringify(photos));
    }

    function loadPhotos() {
        const list = document.getElementById('photo-list');
        list.innerHTML = "";
        JSON.parse(localStorage.getItem('os_photos') || "[]").forEach(src => {
            const img = document.createElement('img');
            img.src = src; img.style.width = "100%";
            list.appendChild(img);
        });
    }

    /* 4. THE EXPORTER (Saves everything into a new HTML file) */
    function exportOS() {
        const currentHTML = document.documentElement.outerHTML;
        // Collect current storage
        const storageData = JSON.stringify(localStorage);
        
        // Create a script that injects the storage back in when the saved file is opened
        const injectScript = `<script>
            const data = ${storageData};
            Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
            console.log("OS State Restored");
        <\/script>`;

        const blob = new Blob([injectScript + currentHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "MyPersonalOS_Backup.html";
        a.click();
    }

    /* 5. Dragging Logic */
    let dragItem = null; let offset = {x:0, y:0};
    document.addEventListener('mousedown', e => {
        const header = e.target.closest('.window-header');
        if(header) {
            dragItem = header.parentElement;
            offset.x = e.clientX - dragItem.offsetLeft;
            offset.y = e.clientY - dragItem.offsetTop;
            dragItem.style.zIndex = 1000;
        }
    });
    document.addEventListener('mousemove', e => {
        if(dragItem) {
            dragItem.style.left = (e.clientX - offset.x) + 'px';
            dragItem.style.top = (e.clientY - offset.y) + 'px';
        }
    });
    document.addEventListener('mouseup', () => dragItem = null);
</script>

</body>
</html>