<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chromebook Portable OS</title>
    <!-- Ruffle Engine -->
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #0f172a; font-family: sans-serif; }
        #desktop { width: 100%; height: 100%; position: relative; }
        .icon { width: 80px; color: white; text-align: center; cursor: pointer; padding: 10px; display: inline-block; }
        .window { position: absolute; background: white; border: 1px solid #000; display: none; flex-direction: column; width: 400px; height: 300px; z-index: 10; border-radius: 8px; }
        .header { background: #334155; color: white; padding: 10px; cursor: move; display: flex; justify-content: space-between; }
        #taskbar { position: absolute; bottom: 0; width: 100%; height: 40px; background: #000; display: flex; align-items: center; padding: 0 10px; }
        .btn { background: #3b82f6; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; margin-right: 5px; }
    </style>
</head>
<body>
    <div id="desktop">
        <div class="icon" onclick="openApp('game-win')">ðŸŽ®<br>Play Game</div>
        <div class="icon" onclick="document.getElementById('swf-upload').click()">ðŸ“‚<br>Load .swf</div>
        <input type="file" id="swf-upload" hidden accept=".swf" onchange="loadSWF(this)">

        <!-- Game Window -->
        <div id="game-win" class="window" style="width:600px; height:400px; top:50px; left:50px;">
            <div class="header"><span>Ruffle Player</span><button onclick="closeApp('game-win')">X</button></div>
            <div id="ruffle-container" style="flex:1; background:#000;"></div>
        </div>

        <div id="taskbar">
            <button class="btn" onclick="exportOS()">ðŸ’¾ Save OS to HTML</button>
            <span style="color:gray; font-size:12px;">(Saves everything into a new file you can take home)</span>
        </div>
    </div>

    <script>
        const ruffle = window.RufflePlayer.newest();
        const player = ruffle.createPlayer();
        document.getElementById('ruffle-container').appendChild(player);

        function openApp(id) { document.getElementById(id).style.display = 'flex'; }
        function closeApp(id) { document.getElementById(id).style.display = 'none'; }

        function loadSWF(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = e => {
                player.load({ data: e.target.result });
                openApp('game-win');
            };
            reader.readAsArrayBuffer(file);
        }

        // PORTABLE SAVE: This copies your current state into a new HTML file
        function exportOS() {
            const state = JSON.stringify(localStorage);
            const blob = new Blob([`<script>localStorage.clear(); const d=${state}; Object.keys(d).forEach(k=>localStorage.setItem(k,d[k]));<\/script>` + document.documentElement.outerHTML], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "My_Chromebook_OS_Backup.html";
            a.click();
        }

        // Draggable Logic
        let win = null; let ox, oy;
        document.addEventListener('mousedown', e => {
            if(e.target.closest('.header')) {
                win = e.target.closest('.window');
                ox = e.clientX - win.offsetLeft; oy = e.clientY - win.offsetTop;
            }
        });
        document.addEventListener('mousemove', e => { if(win) { win.style.left = (e.clientX - ox)+'px'; win.style.top = (e.clientY - oy)+'px'; } });
        document.addEventListener('mouseup', () => win = null);
    </script>
</body>
</html>
